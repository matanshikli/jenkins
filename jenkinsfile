pipeline {
    agent any

    environment {
        // Define environment variable for Docker image tag
        IMAGE_TAG = "matanshikli/project:${env.BUILD_NUMBER}"
    }

    stages {
        stage('Build') {
            steps {
                echo 'Building...'
                sh 'docker build -t $IMAGE_TAG .'
            }
        }

        stage('Test') {
            steps {
                echo 'Testing...'
                sh 'docker run -t $IMAGE_TAG .'
            }
        }

        stage('Docker Push') {
            steps {
                echo 'Pushing Docker Image...'
                // sh 'docker push $IMAGE_TAG'
            }
        }

        stage('Merge to Master') {
            steps {
                script {
                    if (currentBuild.result == 'SUCCESS') {
                        // Merge to master branch
                        // This requires Git credentials configured in Jenkins
                        sh '''
                            git checkout master
                            git merge development
                            git push origin master
                        '''
                    }
                }
            }
        }
    }
}
